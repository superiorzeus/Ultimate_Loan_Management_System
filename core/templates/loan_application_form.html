<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Loan Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
    </style>
</head>
<body class="p-6 md:p-12">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div class="mb-4 md:mb-0">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">New Loan Application</h1>
            <p class="text-lg text-gray-600">Fill in the details for a new loan request.</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn-secondary inline-flex items-center">
            Return to Dashboard
        </a>
    </header>

    <main class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <form id="loan-application-form" class="space-y-6">
            {% csrf_token %}

            <div>
                <label for="user" class="block text-sm font-medium text-gray-700">
                    {% if request.user.is_staff %}
                        Select Customer
                    {% else %}
                        Customer
                    {% endif %}
                </label>
                {% if request.user.is_staff %}
                <select id="user" name="user" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">Select a customer</option>
                    </select>
                {% else %}
                <input type="text" id="user" name="user_readonly" value="{{ request.user.name }}" readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-gray-100 cursor-not-allowed">
                {% endif %}
            </div>

            <div>
                <label for="loan-type" class="block text-sm font-medium text-gray-700">Loan Type</label>
                <select id="loan-type" name="loan_type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">Select a loan type</option>
                    </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="interest-rate" class="block text-sm font-medium text-gray-700">Interest Rate (%)</label>
                    <input type="text" id="interest-rate" name="interest_rate" readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 cursor-not-allowed" placeholder="Auto-populated">
                </div>
                <div>
                    <label for="interest-rate-type" class="block text-sm font-medium text-gray-700">Interest Type</label>
                    <input type="text" id="interest-rate-type" name="interest_rate_type" readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 cursor-not-allowed" placeholder="Auto-populated">
                </div>
                <div>
                    <label for="term-months" class="block text-sm font-medium text-gray-700">Term (Months)</label>
                    <input type="text" id="term-months" name="term_months" readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-gray-100 cursor-not-allowed" placeholder="Auto-populated">
                </div>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                <input type="number" id="amount" name="amount" required step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 5000">
            </div>

            <div>
                <button type="submit" class="btn-primary w-full">Submit Application</button>
            </div>
        </form>

        <div id="message" class="mt-4 p-4 rounded-md text-sm" role="alert" style="display: none;"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = window.location.origin;
            // Check if the user is an admin
            const userIsAdmin = "{{ request.user.is_staff }}" === "True";
            
            const loanTypeSelect = document.getElementById('loan-type');
            const interestRateInput = document.getElementById('interest-rate');
            const interestRateTypeInput = document.getElementById('interest-rate-type');
            const termMonthsInput = document.getElementById('term-months');
            const userSelect = document.getElementById('user');
            const messageDiv = document.getElementById('message');

            const fetchLoanTypes = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/loan-types/`);
                    if (!response.ok) throw new Error('Failed to fetch loan types.');
                    const loanTypes = await response.json();
                    
                    loanTypes.forEach(loanType => {
                        const option = document.createElement('option');
                        option.value = loanType.id;
                        option.textContent = loanType.name;
                        option.dataset.interestRate = loanType.interest_rate;
                        option.dataset.interestRateType = loanType.interest_rate_type;
                        option.dataset.termMonths = loanType.term_months;
                        loanTypeSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error fetching loan types:", error);
                    showMessage(`Failed to load loan types: ${error.message}`, 'bg-red-100 text-red-700');
                }
            };
            
            const fetchCustomers = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/customers/list/`);
                    if (!response.ok) throw new Error('Failed to fetch customers.');
                    const customers = await response.json();
                    
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        userSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error fetching customers:", error);
                    showMessage(`Failed to load customer list: ${error.message}`, 'bg-red-100 text-red-700');
                }
            };
            
            // Event listener for dynamic field population
            loanTypeSelect.addEventListener('change', (event) => {
                const selectedOption = event.target.options[event.target.selectedIndex];
                if (selectedOption.value) {
                    interestRateInput.value = selectedOption.dataset.interestRate;
                    interestRateTypeInput.value = selectedOption.dataset.interestRateType;
                    termMonthsInput.value = selectedOption.dataset.termMonths;
                } else {
                    interestRateInput.value = '';
                    interestRateTypeInput.value = '';
                    termMonthsInput.value = '';
                }
            });

            // Form submission handler
            document.getElementById('loan-application-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                const payload = {
                    loan_type: data.loan_type,
                    amount: data.amount,
                };

                // Set the user field based on who is logged in
                if (userIsAdmin) {
                    payload.user = data.user;
                } else {
                    // For customers, the user is the authenticated user
                    payload.user = "{{ request.user.id }}";
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/loan-applications/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Authorization': `Token {{ request.user.auth_token.key }}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        showMessage('Loan application submitted successfully!', 'bg-green-100 text-green-700');
                        e.target.reset();
                        loanTypeSelect.value = '';
                        interestRateInput.value = '';
                        interestRateTypeInput.value = '';
                        termMonthsInput.value = '';
                    } else {
                        const errorMsg = JSON.stringify(result);
                        showMessage(`Error: ${errorMsg}`, 'bg-red-100 text-red-700');
                    }
                } catch (error) {
                    console.error("Form submission failed:", error);
                    showMessage('Form submission failed. Please try again.', 'bg-red-100 text-red-700');
                }
            });

            function showMessage(msg, className) {
                messageDiv.textContent = msg;
                messageDiv.className = `mt-4 p-4 rounded-md text-sm ${className}`;
                messageDiv.style.display = 'block';
            }

            // Fetch data based on user type
            if (userIsAdmin) {
                fetchCustomers();
            }
            fetchLoanTypes();
        });
    </script>
</body>
</html>